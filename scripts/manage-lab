#!/bin/bash

COMPOSE_FILE="compose.yaml"

show_help() {
    local script_name
    script_name=$(basename "$0")

    cat << EOF
Usage: ${script_name} [COMMAND]

Commands:
start    - Start all services (docker compose up -d)
stop     - Stop all services (docker compose down)
restart  - Recreate all services (down + up -d)
help     - Show this help message

EOF
}

if [[ -z "$1" ]]; then
    show_help
    exit 1
fi

ACTION=$1

if [[ "$ACTION" == "help" || "$ACTION" == "--help" || "$ACTION" == "-h" ]]; then
    show_help
    exit 0
fi

if [[ ! "$ACTION" =~ ^(start|stop|restart)$ ]]; then
    echo "âŒ Error: Invalid argument '$ACTION'"
    echo ""
    show_help
    exit 1
fi

echo "ðŸš€ Running '$ACTION' on all services..."

# --- Main Loop ---
find . -name "$COMPOSE_FILE" -not -path '*/.*' | sort | while read -r file; do

    dir=$(dirname "$file")

    echo "------------------------------------------------"
    echo "ðŸ“‚ Processing: $dir"

    pushd "$dir" > /dev/null

    case $ACTION in
        start)
            docker compose up -d
            ;;
        stop)
            docker compose down
            ;;
        restart)
            docker compose down && docker compose up -d
            ;;
    esac

    popd > /dev/null

done

echo "------------------------------------------------"
echo "âœ… Operation '$ACTION' completed for all services."
